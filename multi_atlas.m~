function [] = multi_atlas(WDIR,fn_img_targ,fn_coords_targ,fn_atlas_list)

varNames = {'fnimg','fnseg','fnmask','fncoords'};
varTypes = {'char','char','char','char'} ;
delimiter = ',';
dataStartLine = 1;
extraColRule = 'ignore';

opts = delimitedTextImportOptions('VariableNames',varNames,...
                                  'VariableTypes',varTypes,...
                                  'Delimiter',delimiter,...
                                  'DataLines', dataStartLine,...
                                  'ExtraColumnsRule',extraColRule); 

atlas_set = readtable(fn_atlas_list,opts);
n_atlas = size(atlas_set,1);

coords_targ = readmatrix(fn_coords_targ);
n_coords = size(coords_targ,1);
coords_targ = [coords_targ(:,1:3)'; ones(1,n_coords)];

for i = 1 : n_atlas
   
    fn_img_atlas = char(atlas_set{i,1});
    fn_seg_atlas = char(atlas_set{i,2});
    fn_mask_atlas = char(atlas_set{i,3});
    
    fn_coords_atlas = char(atlas_set{i,4});
    coords_atlas = readmatrix(fn_coords_atlas);
    coords_atlas = [coords_atlas(:,1:3)'; ones(1,n_coords)];
    
    affine_init = similarity_tform(coords_targ,coords_atlas);
    fn_affine_init = [WDIR '/affine_init_atlas' sprintf('%02d',i) '.mat'];
    dlmwrite(fn_affine_init,inv(affine_init),' ');
    fn_affine_inv_init = [WDIR '/affine_init_atlas' sprintf('%02d',i) '_inv.mat'];
    dlmwrite(fn_affine_inv_init,affine_init,' ');
    
%     fn_regout_deform_init = [WDIR '/deform_init_atlas' sprintf('%02d',i) '.nii.gz'];
%     fn_regout_deform_inv_init = [WDIR '/deform_init_atlas' sprintf('%02d',i) '_inv.nii.gz'];
%     system(['/usr/local/bin/greedy -d 3 '...
%                         '-i ' fn_img_atlas ' ' fn_img_targ ' '...
%                         '-m SSD '...
%                         '-it ' fn_affine_inv_init ' ' ...
%                         '-n 100x1 '...
%                         '-gm ' fn_mask_atlas ' ' ...
%                         '-s 3mm 1.5mm '...
%                         '-o ' fn_regout_deform_init ' '...
%                         '-oinv ' fn_regout_deform_inv_init]);

%     fn_mask_targ = [WDIR '/mask' sprintf('%02d',i) '.nii.gz'];           
%     system(['/usr/local/bin/greedy -d 3 ' ...
%                     '-rf ' fn_img_targ ' ' ...
%                     '-ri NN '...
%                     '-rm ' fn_mask_atlas ' ' fn_mask_targ ' ' ...
%                     '-r ' fn_affine_init ' ' fn_regout_deform_inv_init]);

fn_mask_targ = [WDIR '/mask' sprintf('%02d',i) '.nii.gz'];  
system(['/usr/local/bin/greedy -d 3 ' ...
                    '-rf ' fn_img_targ ' ' ...
                    '-ri NN '...
                    '-rm ' fn_mask_atlas ' ' fn_mask_targ ' ' ...
                    '-r ' fn_affine_init ' ' fn_regout_deform_inv_init]);
    
%     fn_affine_greedy = [WDIR '/affine_greedy' sprintf('%02d',i) '.mat'];
%     system(['/usr/local/bin/greedy -d 3 -a ' ...
%             '-i ' fn_img_targ ' ' fn_img_atlas ' '...
%             '-gm ' fn_mask_targ ' '...
%             '-ia ' fn_affine_init ' '...
%             '-dof 6 '...
%             '-o ' fn_affine_greedy ' '...
%             '-n 100x50x0 -m NCC 4x4x4']);
    
    fn_img_atlas_affine_reslice = [WDIR '/img_atlas' sprintf('%02d',i) '_affine_reslice.nii.gz'];
    system(['/usr/local/bin/greedy -d 3 ' ...
        '-rf ' fn_img_targ ' ' ...
        '-ri LINEAR '...
        '-rm ' fn_img_atlas ' ' fn_img_atlas_affine_reslice ' ' ...
        '-r ' fn_affine_init]); 
    
    fn_img_targ_masked = [WDIR '/img_targ_atlas' sprintf('%02d',i) '_masked.nii.gz'];
    fn_img_atlas_affine_reslice_masked = [WDIR '/img_atlas' sprintf('%02d',i) '_affine_reslice_masked.nii.gz'];
    system(['/usr/local/bin/c3d ' fn_img_atlas_affine_reslice ' ' fn_mask_targ ' -multiply -o ' fn_img_atlas_affine_reslice_masked]);
    system(['/usr/local/bin/c3d ' fn_img_targ ' ' fn_mask_targ ' -multiply -o ' fn_img_targ_masked]);

    fn_regout_deform = [WDIR '/deform_atlas' sprintf('%02d',i) '.nii.gz'];
    system(['/usr/local/bin/greedy -d 3 '...
                        '-i ' fn_img_targ_masked ' ' fn_img_atlas_affine_reslice_masked ' '...
                        '-m SSD '...
                        '-n 100x150x100 '...
                        '-gm ' fn_mask_targ ' ' ...
                        '-o ' fn_regout_deform ' ']);
                        %'-it ' fn_affine_final ' ' ...
                    
    fn_seg_targ = [WDIR '/seg_atlas' sprintf('%02d',i) '.nii.gz']; 
    system(['/usr/local/bin/greedy -d 3 ' ...
        '-rf ' fn_img_targ ' ' ...
        '-ri NN '...
        '-rm ' fn_seg_atlas ' ' fn_seg_targ ' ' ...
        '-r ' fn_regout_deform ' ' fn_affine_init]); 
    
    fn_img_atlas_reslice = [WDIR '/img_atlas' sprintf('%02d',i) '_reslice.nii.gz'];
    system(['/usr/local/bin/greedy -d 3 ' ...
        '-rf ' fn_img_targ ' ' ...
        '-ri LINEAR '...
        '-rm ' fn_img_atlas_affine_reslice_masked ' ' fn_img_atlas_reslice ' ' ...
        '-r ' fn_regout_deform]); 
    
end